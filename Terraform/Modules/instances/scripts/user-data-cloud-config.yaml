#cloud-config
hostname: ${NAME}
timezone: ${TIME_ZONE}
preserve_hostname: false
package_update: true
package_upgrade: true
users:
  - default
  - name: ubuntu
    groups:
      - sudo
    shell: /bin/bash
    ssh_authorized_keys:
      - ${SSH_PUBLIC_KEY}
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: false
    passwd: "${NEW_PASSWORD}"
chpasswd:
  expire: false

packages:
  - qemu-guest-agent
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - software-properties-common
  - nfs-common
  - ufw

write_files:
  - path: /etc/modules-load.d/k8s.conf
    owner: root:root
    permissions: '0644'
    content: |
      overlay
      br_netfilter

  - path: /etc/sysctl.d/k8s.conf
    owner: root:root
    permissions: '0644'
    content: |
      net.bridge.bridge-nf-call-ip6tables = 1
      net.bridge.bridge-nf-call-iptables = 1
      net.ipv4.ip_forward = 1

  - path: /etc/containerd/config.toml
    owner: root:root
    permissions: '0644'
    content: |
      version = 2
      [plugins."io.containerd.grpc.v1.cri".registry]
        config_path = "/etc/containerd/certs.d"

  - path: /etc/containerd/certs.d/docker.io/hosts.toml
    owner: root:root
    permissions: '0644'
    content: |
      server = "https://registry-1.docker.io"

      [host."http://${REGISTRY}"]
        capabilities = ["pull", "resolve"]
        skip_verify = true

  - path: /etc/environment
    owner: root:root
    permissions: '0644'
    content: |
      # /etc/environment (no exports)
      AWS_ACCESS_KEY_ID=${MINIO_ACCESS_KEY}
      AWS_SECRET_ACCESS_KEY=${MINIO_SECRET_KEY}
      MINIO_ENDPOINT=${MINIO_ENDPOINT}
      POD_NETWORK_CIDR=${POD_NETWORK_CIDR}

  - path: /etc/profile.d/app_env.sh
    owner: ubuntu:ubuntu
    permissions: '0644'
    content: |
      # /etc/profile.d/app_env.sh
      export AWS_ACCESS_KEY_ID=${MINIO_ACCESS_KEY}
      export AWS_SECRET_ACCESS_KEY=${MINIO_SECRET_KEY}
      export MINIO_ENDPOINT=${MINIO_ENDPOINT}
      export POD_NETWORK_CIDR=${POD_NETWORK_CIDR}
      export CNI_MANIFEST_URL=${CNI_MANIFEST_URL}
  
runcmd:
  - chmod +x /etc/profile.d/app_env.sh  
  - wget https://dl.min.io/client/mc/release/linux-amd64/mc -O /usr/local/bin/mc
  - chmod +x /usr/local/bin/mc
  - [ systemctl, enable, qemu-guest-agent]

  - [ systemctl, start, qemu-guest-agent]
  # Disable swap and prevent it from being mounted again
  - [ swapoff, -a ]
  - [ sed, -i, '/ swap / s/^\(.*\)$/#\1/', /etc/fstab ]

  # Ensure kernel modules are loaded now
  - [ modprobe, overlay ]
  - [ modprobe, br_netfilter ]

  # Apply sysctl settings
  - [ sysctl, --system ]

  # Prepare apt keyrings dir
  - [ mkdir, -p, /etc/apt/keyrings ]

  # Add Kubernetes apt key and repo (${KUBERNETES_VERSION} stable URL used in your snippet)
  - [ bash, -c, "curl -fsSL https://pkgs.k8s.io/core:/stable:/${KUBERNETES_VERSION}/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg" ]
  - [ bash, -c, 'echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/${KUBERNETES_VERSION}/deb/ /" > /etc/apt/sources.list.d/kubernetes.list' ]

  # Update apt and install containerd first
  - [ apt, update ]
  - [ apt, install, -y, containerd ]

  # Configure containerd and enable service
  - [ mkdir, -p, /etc/containerd ]
  - [ bash, -c, "containerd config default | tee /etc/containerd/config.toml" ]
  - [ systemctl, restart, containerd ]
  - [ systemctl, enable, containerd ]

  # Install kube packages from the added repository and hold them
  - [ apt, update ]
  - [ apt, install, -y, kubelet, kubeadm, kubectl ]
  - [ apt-mark, hold, kubelet, kubeadm, kubectl ]


  # Finalmente reiniciamos containerd y kubelet
  - [ systemctl, daemon-reload ]
  - [ systemctl, restart, containerd ]
  - [ systemctl, restart, kubelet ]
  # Basic system access
  - ufw allow, 22/tcp                    # SSH
  # Kubernetes API server (masters only, but safe for all)
  - ufw allow 6443/tcp
  # etcd (masters only)
  - ufw allow 2379:2380/tcp
  # kubelet API for all nodes
  - ufw allow 10250/tcp
  # kube-scheduler + controller-manager (masters only)
  - ufw allow 10257/tcp
  - ufw allow 10259/tcp
  # NodePort range
  - ufw allow 30000:32767/tcp
  # For Flannel (VXLAN)
  - ufw allow 8472/udp
  # For Calico (if you use it)
  - ufw allow 179/tcp
  # For kubeadm control-plane node load balancing (optional)
  - ufw allow 10256/tcp
  # Enable UFW
  #- echo "y" | ufw enable
  # Restart services
  #- systemctl restart ufw
# End of cloud-config
